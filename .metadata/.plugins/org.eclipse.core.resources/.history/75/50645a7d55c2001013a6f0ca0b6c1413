package com.adb.fx.controller;

import javafx.fxml.FXML;
import javafx.fxml.FXMLLoader;
import javafx.scene.Parent;
import javafx.scene.Scene;
import javafx.scene.control.*;
import javafx.scene.layout.VBox;
import javafx.stage.Stage;

import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.io.OutputStream;
import java.net.HttpURLConnection;
import java.net.URL;
import java.nio.charset.StandardCharsets;
import org.json.JSONObject;

import com.adb.fx.model.Usuario;
import com.adb.fx.controller.PerfilController;

public class LoginController {

    // Tabs
    @FXML private Button btnTabLogin;
    @FXML private Button btnTabRegistro;
    
    // Formularios
    @FXML private ScrollPane registroFormScroll;
    @FXML private VBox loginForm;
    @FXML private VBox registroForm;
    
    // Campos de Login
    @FXML private TextField txtLoginUsuario;
    @FXML private PasswordField txtLoginPassword;
    @FXML private CheckBox chkRecordarme;
    
    // Campos de Registro
    @FXML private TextField txtRegistroNombre;
    @FXML private TextField txtRegistroEmail;
    @FXML private TextField txtRegistroUsuario;
    @FXML private PasswordField txtRegistroPassword;
    @FXML private PasswordField txtRegistroConfirmPassword;
    @FXML private CheckBox chkTerminos;

    @FXML
    public void initialize() {
        // Iniciar mostrando el formulario de login
        mostrarLogin();
    }

    /**
     * Muestra el formulario de login
     */
    @FXML
    private void mostrarLogin() {
        loginForm.setVisible(true);
        registroFormScroll.setVisible(false);
        
        // Cambiar estilos de tabs
        btnTabLogin.getStyleClass().clear();
        btnTabLogin.getStyleClass().add("login-tab-button-active");
        
        btnTabRegistro.getStyleClass().clear();
        btnTabRegistro.getStyleClass().add("login-tab-button");
    }

    /**
     * Muestra el formulario de registro
     */
    @FXML
    private void mostrarRegistro() {
        loginForm.setVisible(false);
        registroFormScroll.setVisible(true);
        
        // Cambiar estilos de tabs
        btnTabRegistro.getStyleClass().clear();
        btnTabRegistro.getStyleClass().add("login-tab-button-active");
        
        btnTabLogin.getStyleClass().clear();
        btnTabLogin.getStyleClass().add("login-tab-button");
    }

    /**
     * Procesa el inicio de sesión
     */
    @FXML
    private void iniciarSesion() {
        String correoIngresado = txtLoginUsuario.getText().trim();
        String passwordIngresado = txtLoginPassword.getText();

        // Validaciones básicas
        if (correoIngresado.isEmpty() || passwordIngresado.isEmpty()) {
            mostrarAlerta("Por favor completa todos los campos", Alert.AlertType.WARNING);
            return;
        }

        try {
            // URL
            String urlString = "http://localhost:8083/usuarios/login";
            
            URL url = new URL(urlString);
            HttpURLConnection con = (HttpURLConnection) url.openConnection();
            con.setRequestMethod("POST");
            con.setRequestProperty("Content-Type", "application/json");
            con.setDoOutput(true);

            // Crear JSON con las CLAVES correctas
            JSONObject json = new JSONObject();
            json.put("correo", correoIngresado);
            json.put("contrasena", passwordIngresado);

            System.out.println("Enviando a: " + urlString);
            System.out.println("JSON: " + json.toString());

            // Enviar datos
            try (OutputStream os = con.getOutputStream()) {
                byte[] input = json.toString().getBytes(StandardCharsets.UTF_8);
                os.write(input, 0, input.length);
            }

            int responseCode = con.getResponseCode();
            System.out.println("Response Code: " + responseCode);
            
            if (responseCode == 200) {
                // Login exitoso
                BufferedReader in = new BufferedReader(
                    new InputStreamReader(con.getInputStream(), StandardCharsets.UTF_8)
                );
                StringBuilder response = new StringBuilder();
                String line;
                while ((line = in.readLine()) != null) {
                    response.append(line);
                }
                in.close();

                System.out.println("Response: " + response.toString());

                // Parsear respuesta
                JSONObject responseJson = new JSONObject(response.toString());
                
                // Crear objeto Usuario con los datos recibidos
                Usuario usuario = new Usuario();
                usuario.setIdUsuario(responseJson.optInt("idUsuario"));
                usuario.setNombre(responseJson.optString("nombre"));
                usuario.setApellido(responseJson.optString("apellido"));
                usuario.setCorreo(responseJson.optString("correo"));
                usuario.setRol(responseJson.optString("rol"));
                usuario.setIdDeporte(responseJson.optInt("idDeporte"));
                
                // Parsear fecha si existe
                if (!responseJson.isNull("fechaRegistro")) {
                    try {
                        usuario.setFechaRegistro(java.time.LocalDate.parse(responseJson.getString("fechaRegistro")));
                    } catch (Exception e) {
                        System.out.println("Error al parsear fecha: " + e.getMessage());
                    }
                }
                
                System.out.println("✅ Usuario creado: " + usuario.getNombre() + " " + usuario.getApellido());
                
                // Navegar a PERFIL y pasar el usuario
                FXMLLoader loader = new FXMLLoader(getClass().getResource("/Perfil.fxml"));
                Parent root = loader.load();
                
                // Obtener el controller y pasarle el usuario
                PerfilController perfilController = loader.getController();
                perfilController.setUsuario(usuario);
                
                Stage stage = (Stage) txtLoginUsuario.getScene().getWindow();
                stage.setScene(new Scene(root));
                stage.show();
                
            } else {
                // Leer el mensaje de error
                BufferedReader errorReader = new BufferedReader(
                    new InputStreamReader(con.getErrorStream(), StandardCharsets.UTF_8)
                );
                StringBuilder errorMsg = new StringBuilder();
                String errorLine;
                while ((errorLine = errorReader.readLine()) != null) {
                    errorMsg.append(errorLine);
                }
                errorReader.close();
                
                System.out.println("Error: " + errorMsg.toString());
                mostrarAlerta(errorMsg.toString(), Alert.AlertType.ERROR);
            }

        } catch (Exception e) {
            e.printStackTrace();
            mostrarAlerta("No se pudo conectar con el servidor:\n" + e.getMessage(), Alert.AlertType.ERROR);
        }
    }
    
    @FXML
    private void irALoginAdmin() {
        try {
            FXMLLoader loader = new FXMLLoader(getClass().getResource("/LoginAdmin.fxml"));
            Parent root = loader.load();
            
            Stage stage = (Stage) txtLoginUsuario.getScene().getWindow();
            stage.setScene(new Scene(root));
            stage.setTitle("Nexus Deportivo - Acceso Administrativo");
            stage.show();
            
        } catch (Exception e) {
            e.printStackTrace();
            mostrarAlerta("Error al cargar la pantalla de administrador: " + e.getMessage(), 
                         Alert.AlertType.ERROR);
        }
    }
    private void iniciarSesionAdmin() {
        String correoIngresado = txtLoginUsuario.getText().trim();
        String passwordIngresado = txtLoginPassword.getText();

        // Validaciones básicas
        if (correoIngresado.isEmpty() || passwordIngresado.isEmpty()) {
            mostrarAlerta("Por favor completa todos los campos", Alert.AlertType.WARNING);
            return;
        }

        try {
            // URL
            String urlString = "http://localhost:8083/usuarios/login";
            
            URL url = new URL(urlString);
            HttpURLConnection con = (HttpURLConnection) url.openConnection();
            con.setRequestMethod("POST");
            con.setRequestProperty("Content-Type", "application/json");
            con.setDoOutput(true);

            // Crear JSON con las CLAVES correctas
            JSONObject json = new JSONObject();
            json.put("correo", correoIngresado);
            json.put("contrasena", passwordIngresado);

            System.out.println("Enviando a: " + urlString);
            System.out.println("JSON: " + json.toString());

            // Enviar datos
            try (OutputStream os = con.getOutputStream()) {
                byte[] input = json.toString().getBytes(StandardCharsets.UTF_8);
                os.write(input, 0, input.length);
            }

            int responseCode = con.getResponseCode();
            System.out.println("Response Code: " + responseCode);
            
            if (responseCode == 200) {
                // Login exitoso
                BufferedReader in = new BufferedReader(
                    new InputStreamReader(con.getInputStream(), StandardCharsets.UTF_8)
                );
                StringBuilder response = new StringBuilder();
                String line;
                while ((line = in.readLine()) != null) {
                    response.append(line);
                }
                in.close();

                System.out.println("Response: " + response.toString());

                // Parsear respuesta
                JSONObject responseJson = new JSONObject(response.toString());
                
                // Crear objeto Usuario con los datos recibidos
                Usuario usuario = new Usuario();
                usuario.setIdUsuario(responseJson.optInt("idUsuario"));
                usuario.setNombre(responseJson.optString("nombre"));
                usuario.setApellido(responseJson.optString("apellido"));
                usuario.setCorreo(responseJson.optString("correo"));
                usuario.setRol(responseJson.optString("rol"));
                usuario.setIdDeporte(responseJson.optInt("idDeporte"));
                
                // Parsear fecha si existe
                if (!responseJson.isNull("fechaRegistro")) {
                    try {
                        usuario.setFechaRegistro(java.time.LocalDate.parse(responseJson.getString("fechaRegistro")));
                    } catch (Exception e) {
                        System.out.println("Error al parsear fecha: " + e.getMessage());
                    }
                }
                
                System.out.println("✅ Usuario creado: " + usuario.getNombre() + " " + usuario.getApellido());
                
                // Navegar a PERFIL y pasar el usuario
                FXMLLoader loader = new FXMLLoader(getClass().getResource("/Perfil.fxml"));
                Parent root = loader.load();
                
                // Obtener el controller y pasarle el usuario
                PerfilController perfilController = loader.getController();
                perfilController.setUsuario(usuario);
                
                Stage stage = (Stage) txtLoginUsuario.getScene().getWindow();
                stage.setScene(new Scene(root));
                stage.show();
                
            } else {
                // Leer el mensaje de error
                BufferedReader errorReader = new BufferedReader(
                    new InputStreamReader(con.getErrorStream(), StandardCharsets.UTF_8)
                );
                StringBuilder errorMsg = new StringBuilder();
                String errorLine;
                while ((errorLine = errorReader.readLine()) != null) {
                    errorMsg.append(errorLine);
                }
                errorReader.close();
                
                System.out.println("Error: " + errorMsg.toString());
                mostrarAlerta(errorMsg.toString(), Alert.AlertType.ERROR);
            }

        } catch (Exception e) {
            e.printStackTrace();
            mostrarAlerta("No se pudo conectar con el servidor:\n" + e.getMessage(), Alert.AlertType.ERROR);
        }
    }

    /**
     * Procesa la creación de cuenta
     */
    @FXML
    private void crearCuenta() {
        String nombre = txtRegistroNombre.getText().trim();
        String email = txtRegistroEmail.getText().trim();
        String usuario = txtRegistroUsuario.getText().trim();
        String password = txtRegistroPassword.getText();
        String confirmPassword = txtRegistroConfirmPassword.getText();

        // Validaciones
        if (nombre.isEmpty() || email.isEmpty() || usuario.isEmpty() || 
            password.isEmpty() || confirmPassword.isEmpty()) {
            mostrarAlerta("Por favor completa todos los campos", Alert.AlertType.WARNING);
            return;
        }

        if (!password.equals(confirmPassword)) {
            mostrarAlerta("Las contraseñas no coinciden", Alert.AlertType.ERROR);
            return;
        }

        if (password.length() < 8) {
            mostrarAlerta("La contraseña debe tener al menos 8 caracteres", Alert.AlertType.WARNING);
            return;
        }

        if (!chkTerminos.isSelected()) {
            mostrarAlerta("Debes aceptar los términos y condiciones", Alert.AlertType.WARNING);
            return;
        }

        if (!validarEmail(email)) {
            mostrarAlerta("Por favor ingresa un email válido", Alert.AlertType.WARNING);
            return;
        }

        try {
            String urlString = "http://localhost:8083/usuarios/registro";
            
            URL url = new URL(urlString);
            HttpURLConnection con = (HttpURLConnection) url.openConnection();
            con.setRequestMethod("POST");
            con.setRequestProperty("Content-Type", "application/json");
            con.setDoOutput(true);

            // Crear JSON con datos del usuario
            JSONObject json = new JSONObject();
            json.put("nombre", nombre);
            json.put("apellido", usuario);
            json.put("correo", email);
            json.put("contrasena", password);

            System.out.println("Enviando a: " + urlString);
            System.out.println("JSON: " + json.toString());

            // Enviar datos
            try (OutputStream os = con.getOutputStream()) {
                byte[] input = json.toString().getBytes(StandardCharsets.UTF_8);
                os.write(input, 0, input.length);
            }

            int responseCode = con.getResponseCode();
            System.out.println("Response Code: " + responseCode);
            
            if (responseCode == 200 || responseCode == 201) {
                mostrarAlerta("Tu cuenta ha sido creada. Ya puedes iniciar sesión.", Alert.AlertType.INFORMATION);
                
                // Cambiar a la vista de login
                limpiarCamposRegistro();
                mostrarLogin();
                
            } else {
                BufferedReader in = new BufferedReader(
                    new InputStreamReader(con.getErrorStream(), StandardCharsets.UTF_8)
                );
                StringBuilder errorMsg = new StringBuilder();
                String line;
                while ((line = in.readLine()) != null) {
                    errorMsg.append(line);
                }
                in.close();
                
                System.out.println("Error del servidor: " + errorMsg.toString());
                mostrarAlerta(errorMsg.toString(), Alert.AlertType.ERROR);
            }

        } catch (Exception e) {
            e.printStackTrace();
            mostrarAlerta("No se pudo conectar con el servidor:\n" + e.getMessage(), Alert.AlertType.ERROR);
        }
    }

    /**
     * Recuperar contraseña
     */
    @FXML
    private void recuperarContrasena() {
        TextInputDialog dialog = new TextInputDialog();
        dialog.setTitle("Recuperar Contraseña");
        dialog.setHeaderText("Ingresa tu email");
        dialog.setContentText("Email:");

        dialog.showAndWait().ifPresent(email -> {
            if (validarEmail(email)) {
                mostrarAlerta("Se ha enviado un enlace de recuperación a tu email", Alert.AlertType.INFORMATION);
            } else {
                mostrarAlerta("Por favor ingresa un email válido", Alert.AlertType.ERROR);
            }
        });
    }

    /**
     * Ver términos y condiciones
     */
    @FXML
    private void verTerminos() {
        Alert alert = new Alert(Alert.AlertType.INFORMATION);
        alert.setTitle("Términos y Condiciones");
        alert.setHeaderText("Términos y Condiciones de Uso");
        alert.setContentText(
            "1. Aceptación de términos\n" +
            "2. Uso del servicio\n" +
            "3. Privacidad de datos\n" +
            "4. Responsabilidades del usuario\n\n" +
            "Para ver los términos completos, visita nuestro sitio web."
        );
        alert.showAndWait();
    }

    /**
     * Volver a la vista principal
     */
    @FXML
    private void volverInicio() {
        try {
            FXMLLoader loader = new FXMLLoader(getClass().getResource("/vista.fxml"));
            Parent root = loader.load();
            Stage stage = (Stage) txtLoginUsuario.getScene().getWindow();
            Scene scene = new Scene(root);
            stage.setScene(scene);
            stage.show();
        } catch (Exception e) {
            e.printStackTrace();
            mostrarAlerta("No se pudo cargar la vista principal:\n" + e.getMessage(), Alert.AlertType.ERROR);
        }
    }

    /**
     * Valida formato de email
     */
    private boolean validarEmail(String email) {
        String regex = "^[A-Za-z0-9+_.-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}$";
        return email.matches(regex);
    }

    /**
     * Limpia los campos del formulario de registro
     */
    private void limpiarCamposRegistro() {
        txtRegistroNombre.clear();
        txtRegistroEmail.clear();
        txtRegistroUsuario.clear();
        txtRegistroPassword.clear();
        txtRegistroConfirmPassword.clear();
        chkTerminos.setSelected(false);
    }

    /**
     * Muestra una alerta
     */
    private void mostrarAlerta(String mensaje, Alert.AlertType tipo) {
        Alert alert = new Alert(tipo);
        alert.setTitle(tipo == Alert.AlertType.ERROR ? "Error" : 
                      tipo == Alert.AlertType.WARNING ? "Advertencia" : "Información");
        alert.setHeaderText(null);
        alert.setContentText(mensaje);
        alert.showAndWait();
    }
}