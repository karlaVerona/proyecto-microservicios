package com.adb.fx.controller;

import javafx.collections.FXCollections;
import javafx.collections.ObservableList;
import javafx.fxml.FXML;
import javafx.fxml.FXMLLoader;
import javafx.scene.Parent;
import javafx.scene.Scene;
import javafx.scene.control.*;
import javafx.scene.control.cell.PropertyValueFactory;
import javafx.scene.layout.VBox;
import javafx.stage.Stage;

import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.io.OutputStream;
import java.net.HttpURLConnection;
import java.net.URL;
import java.nio.charset.StandardCharsets;
import org.json.JSONArray;
import org.json.JSONObject;

import com.adb.fx.model.Usuario;
import com.adb.fx.model.Torneo;

public class PerfilController {

    // Tabs
    @FXML private Button btnTabInformacion;
    @FXML private Button btnTabTorneos;
    @FXML private Button btnTabEditar;
    @FXML private Button btnTabSeguridad;

    // Secciones
    @FXML private VBox seccionInformacion;
    @FXML private VBox seccionTorneos;
    @FXML private VBox seccionEditar;
    @FXML private VBox seccionSeguridad;

    // Header
    @FXML private Label lblNombreCompleto;
    @FXML private Label lblCorreo;
    @FXML private Label lblRol;
    @FXML private Label lblFechaRegistro;

    // Informaci√≥n
    @FXML private Label lblInfoNombre;
    @FXML private Label lblInfoApellido;
    @FXML private Label lblInfoCorreo;
    @FXML private Label lblInfoRol;
    @FXML private Label lblInfoDeporte;

    // Torneos
    @FXML private ComboBox<String> cmbTorneosDisponibles;
    @FXML private TableView<Torneo> tablaMisInscripciones;
    @FXML private TableColumn<Torneo, String> colTorneoNombre;
    @FXML private TableColumn<Torneo, String> colTorneoDeporte;
    @FXML private TableColumn<Torneo, String> colTorneoFecha;
    @FXML private TableColumn<Torneo, String> colTorneoEstado;
    @FXML private TableColumn<Torneo, Void> colTorneoAcciones;

    // Editar
    @FXML private TextField txtEditarNombre;
    @FXML private TextField txtEditarApellido;
    @FXML private TextField txtEditarCorreo;
    @FXML private ComboBox<String> cmbEditarDeporte;

    // Seguridad
    @FXML private PasswordField txtPasswordActual;
    @FXML private PasswordField txtPasswordNueva;
    @FXML private PasswordField txtPasswordConfirmar;

    // Usuario actual
    private Usuario usuarioActual;
    private ObservableList<Torneo> listaTorneosInscritos = FXCollections.observableArrayList();

    @FXML
    public void initialize() {
        // Cargar deportes en el combo
        cmbEditarDeporte.setItems(FXCollections.observableArrayList(
            "F√∫tbol", "Baloncesto", "Tenis", "Nataci√≥n", "Voleibol"
        ));

        // Configurar tabla de inscripciones
        configurarTablaInscripciones();

        // Mostrar secci√≥n de informaci√≥n por defecto
        mostrarInformacion();
    }

    /**
     * Configura las columnas de la tabla de inscripciones
     */
    private void configurarTablaInscripciones() {
        colTorneoNombre.setCellValueFactory(new PropertyValueFactory<>("nombreYClasificacion"));
        colTorneoDeporte.setCellValueFactory(c -> 
            new javafx.beans.property.SimpleStringProperty("Deporte " + c.getValue().getIdDeporte()));
        colTorneoFecha.setCellValueFactory(c -> 
            new javafx.beans.property.SimpleStringProperty(
                c.getValue().getFechaInicio() != null ? c.getValue().getFechaInicio().toString() : ""));
        colTorneoEstado.setCellValueFactory(c -> 
            new javafx.beans.property.SimpleStringProperty("Activo"));

        tablaMisInscripciones.setItems(listaTorneosInscritos);
    }

    /**
     * Establece el usuario actual
     */
    public void setUsuario(Usuario usuario) {
        this.usuarioActual = usuario;
        cargarDatosUsuario();
        cargarTorneosDisponibles();
    }

    /**
     * Carga los datos del usuario en la interfaz
     */
    private void cargarDatosUsuario() {
        if (usuarioActual == null) return;

        // Header
        lblNombreCompleto.setText(usuarioActual.getNombre() + " " + usuarioActual.getApellido());
        lblCorreo.setText(usuarioActual.getCorreo());
        lblRol.setText("üéØ " + (usuarioActual.getRol() != null ? usuarioActual.getRol() : "Jugador"));
        lblFechaRegistro.setText("Miembro desde: " + 
            (usuarioActual.getFechaRegistro() != null ? usuarioActual.getFechaRegistro().toString() : ""));

        // Informaci√≥n
        lblInfoNombre.setText(usuarioActual.getNombre());
        lblInfoApellido.setText(usuarioActual.getApellido());
        lblInfoCorreo.setText(usuarioActual.getCorreo());
        lblInfoRol.setText(usuarioActual.getRol() != null ? usuarioActual.getRol() : "Jugador");
        lblInfoDeporte.setText("F√∫tbol");

        // Editar
        txtEditarNombre.setText(usuarioActual.getNombre());
        txtEditarApellido.setText(usuarioActual.getApellido());
        txtEditarCorreo.setText(usuarioActual.getCorreo());
    }

    /**
     * Carga los torneos disponibles para inscribirse
     */
    private void cargarTorneosDisponibles() {
        try {
            String urlString = "http://localhost:8080/torneos";
            URL url = new URL(urlString);
            HttpURLConnection con = (HttpURLConnection) url.openConnection();
            con.setRequestMethod("GET");

            int responseCode = con.getResponseCode();
            if (responseCode == 200) {
                BufferedReader in = new BufferedReader(
                    new InputStreamReader(con.getInputStream(), StandardCharsets.UTF_8)
                );
                StringBuilder response = new StringBuilder();
                String line;
                while ((line = in.readLine()) != null) {
                    response.append(line);
                }
                in.close();

                JSONArray arr = new JSONArray(response.toString());
                ObservableList<String> torneos = FXCollections.observableArrayList();

                for (int i = 0; i < arr.length(); i++) {
                    JSONObject obj = arr.getJSONObject(i);
                    String nombreTorneo = obj.optString("nombreYClasificacion");
                    torneos.add(nombreTorneo);
                }

                cmbTorneosDisponibles.setItems(torneos);
            }
        } catch (Exception e) {
            e.printStackTrace();
            System.out.println("Error al cargar torneos: " + e.getMessage());
        }
    }

    // ========== NAVEGACI√ìN ENTRE TABS ==========

    @FXML
    private void mostrarInformacion() {
        cambiarTab(btnTabInformacion, seccionInformacion);
    }

    @FXML
    private void mostrarTorneos() {
        cambiarTab(btnTabTorneos, seccionTorneos);
    }

    @FXML
    private void mostrarEditar() {
        cambiarTab(btnTabEditar, seccionEditar);
    }

    @FXML
    private void mostrarSeguridad() {
        cambiarTab(btnTabSeguridad, seccionSeguridad);
    }

    private void cambiarTab(Button tabActivo, VBox seccionActiva) {
        // Ocultar todas las secciones
        seccionInformacion.setVisible(false);
        seccionTorneos.setVisible(false);
        seccionEditar.setVisible(false);
        seccionSeguridad.setVisible(false);

        // Mostrar la secci√≥n activa
        seccionActiva.setVisible(true);

        // Actualizar estilos de tabs
        btnTabInformacion.getStyleClass().clear();
        btnTabTorneos.getStyleClass().clear();
        btnTabEditar.getStyleClass().clear();
        btnTabSeguridad.getStyleClass().clear();

        btnTabInformacion.getStyleClass().add("profile-tab");
        btnTabTorneos.getStyleClass().add("profile-tab");
        btnTabEditar.getStyleClass().add("profile-tab");
        btnTabSeguridad.getStyleClass().add("profile-tab");

        tabActivo.getStyleClass().clear();
        tabActivo.getStyleClass().add("profile-tab-active");
    }

    // ========== FUNCIONES DE TORNEOS ==========

    /**
     * Inscribirse a un torneo seleccionado
     */
    @FXML
    private void inscribirseATorneo() {
        String torneoSeleccionado = cmbTorneosDisponibles.getValue();

        if (torneoSeleccionado == null || torneoSeleccionado.isEmpty()) {
            mostrarAlerta("Por favor selecciona un torneo", Alert.AlertType.WARNING);
            return;
        }

        Alert confirmacion = new Alert(Alert.AlertType.CONFIRMATION);
        confirmacion.setTitle("Confirmar Inscripci√≥n");
        confirmacion.setHeaderText("¬øDeseas inscribirte a este torneo?");
        confirmacion.setContentText(torneoSeleccionado);

        confirmacion.showAndWait().ifPresent(response -> {
            if (response == ButtonType.OK) {
                try {
                    // TODO: Implementar endpoint de inscripci√≥n en el backend
                    mostrarAlerta("¬°Te has inscrito exitosamente al torneo!", Alert.AlertType.INFORMATION);
                    
                    // Recargar la lista de inscripciones
                    // cargarMisInscripciones();
                    
                } catch (Exception e) {
                    e.printStackTrace();
                    mostrarAlerta("Error al inscribirse: " + e.getMessage(), Alert.AlertType.ERROR);
                }
            }
        });
    }

    // ========== FUNCIONES DE PERFIL ==========

    @FXML
    private void guardarCambios() {
        String nombre = txtEditarNombre.getText().trim();
        String apellido = txtEditarApellido.getText().trim();
        String correo = txtEditarCorreo.getText().trim();

        if (nombre.isEmpty() || apellido.isEmpty() || correo.isEmpty()) {
            mostrarAlerta("Por favor completa todos los campos", Alert.AlertType.WARNING);
            return;
        }

        try {
            // TODO: Implementar actualizaci√≥n en el backend
            // String urlString = "http://localhost:8083/usuarios/" + usuarioActual.getIdUsuario();
            // PUT request con los nuevos datos

            mostrarAlerta("Perfil actualizado exitosamente", Alert.AlertType.INFORMATION);
            
            usuarioActual.setNombre(nombre);
            usuarioActual.setApellido(apellido);
            usuarioActual.setCorreo(correo);
            
            cargarDatosUsuario();
            mostrarInformacion();

        } catch (Exception e) {
            e.printStackTrace();
            mostrarAlerta("Error al actualizar perfil: " + e.getMessage(), Alert.AlertType.ERROR);
        }
    }

    @FXML
    private void cancelarEdicion() {
        cargarDatosUsuario();
        mostrarInformacion();
    }

    @FXML
    private void cambiarPassword() {
        String actual = txtPasswordActual.getText();
        String nueva = txtPasswordNueva.getText();
        String confirmar = txtPasswordConfirmar.getText();

        if (actual.isEmpty() || nueva.isEmpty() || confirmar.isEmpty()) {
            mostrarAlerta("Por favor completa todos los campos", Alert.AlertType.WARNING);
            return;
        }

        if (!nueva.equals(confirmar)) {
            mostrarAlerta("Las contrase√±as no coinciden", Alert.AlertType.ERROR);
            return;
        }

        if (nueva.length() < 8) {
            mostrarAlerta("La contrase√±a debe tener al menos 8 caracteres", Alert.AlertType.WARNING);
            return;
        }

        try {
            // TODO: Implementar cambio de contrase√±a en el backend
            mostrarAlerta("Contrase√±a actualizada exitosamente", Alert.AlertType.INFORMATION);
            
            txtPasswordActual.clear();
            txtPasswordNueva.clear();
            txtPasswordConfirmar.clear();

        } catch (Exception e) {
            e.printStackTrace();
            mostrarAlerta("Error al cambiar contrase√±a: " + e.getMessage(), Alert.AlertType.ERROR);
        }
    }

    // ========== ELIMINAR CUENTA ==========

    /**
     * Elimina permanentemente la cuenta del usuario
     */
    @FXML
    private void eliminarCuenta() {
        // Di√°logo de confirmaci√≥n inicial
        Alert confirmacion1 = new Alert(Alert.AlertType.WARNING);
        confirmacion1.setTitle("‚ö†Ô∏è Eliminar Cuenta");
        confirmacion1.setHeaderText("Esta acci√≥n es PERMANENTE");
        confirmacion1.setContentText("¬øEst√°s completamente seguro de que deseas eliminar tu cuenta?\n\n" +
                                    "‚Ä¢ Se eliminar√°n todos tus datos\n" +
                                    "‚Ä¢ Perder√°s tus inscripciones a torneos\n" +
                                    "‚Ä¢ Se borrar√°n tus estad√≠sticas\n" +
                                    "‚Ä¢ Esta acci√≥n NO se puede deshacer");

        ButtonType btnContinuar = new ButtonType("Continuar", ButtonBar.ButtonData.OK_DONE);
        ButtonType btnCancelar = new ButtonType("Cancelar", ButtonBar.ButtonData.CANCEL_CLOSE);
        confirmacion1.getButtonTypes().setAll(btnContinuar, btnCancelar);

        confirmacion1.showAndWait().ifPresent(response -> {
            if (response == btnContinuar) {
                // Segunda confirmaci√≥n con contrase√±a
                TextInputDialog passwordDialog = new TextInputDialog();
                passwordDialog.setTitle("Confirmar Eliminaci√≥n");
                passwordDialog.setHeaderText("Ingresa tu contrase√±a para confirmar");
                passwordDialog.setContentText("Contrase√±a:");
                
                // Hacer que el campo sea de tipo password
                TextField textField = passwordDialog.getEditor();
                textField.setPromptText("Tu contrase√±a");

                passwordDialog.showAndWait().ifPresent(password -> {
                    if (password.isEmpty()) {
                        mostrarAlerta("Debes ingresar tu contrase√±a", Alert.AlertType.WARNING);
                        return;
                    }

                    // Confirmar eliminaci√≥n
                    eliminarCuentaDefinitivamente(password);
                });
            }
        });
    }

    /**
     * Ejecuta la eliminaci√≥n de la cuenta en el backend
     */
    private void eliminarCuentaDefinitivamente(String password) {
        try {
            System.out.println("=== ELIMINANDO CUENTA ===");
            System.out.println("ID Usuario: " + usuarioActual.getIdUsuario());
            
            String urlString = "http://localhost:8083/usuarios/" + usuarioActual.getIdUsuario();
            
            URL url = new URL(urlString);
            HttpURLConnection con = (HttpURLConnection) url.openConnection();
            con.setRequestMethod("DELETE");

            int responseCode = con.getResponseCode();
            System.out.println("Response Code: " + responseCode);
            
            if (responseCode == 200 || responseCode == 204) {
                // Eliminaci√≥n exitosa
                Alert exito = new Alert(Alert.AlertType.INFORMATION);
                exito.setTitle("Cuenta Eliminada");
                exito.setHeaderText("Tu cuenta ha sido eliminada");
                exito.setContentText("Lamentamos verte partir. Tu cuenta y todos tus datos han sido eliminados permanentemente.");
                
                exito.showAndWait();
                
                // Redirigir al login
                irALogin();
                
            } else {
                BufferedReader errorReader = new BufferedReader(
                    new InputStreamReader(con.getErrorStream(), StandardCharsets.UTF_8)
                );
                StringBuilder errorMsg = new StringBuilder();
                String errorLine;
                while ((errorLine = errorReader.readLine()) != null) {
                    errorMsg.append(errorLine);
                }
                errorReader.close();
                
                System.out.println("Error: " + errorMsg.toString());
                mostrarAlerta("Error al eliminar la cuenta: " + errorMsg.toString(), Alert.AlertType.ERROR);
            }

        } catch (Exception e) {
            e.printStackTrace();
            mostrarAlerta("No se pudo conectar con el servidor:\n" + e.getMessage(), Alert.AlertType.ERROR);
        }
    }

    // ========== NAVEGACI√ìN ==========

    @FXML
    private void irATorneos() {
        try {
            FXMLLoader loader = new FXMLLoader(getClass().getResource("/vista.fxml"));
            Parent root = loader.load();
            Stage stage = (Stage) lblNombreCompleto.getScene().getWindow();
            stage.setScene(new Scene(root));
            stage.show();
        } catch (Exception e) {
            e.printStackTrace();
            mostrarAlerta("Error al cargar torneos: " + e.getMessage(), Alert.AlertType.ERROR);
        }
    }

    private void irALogin() {
        try {
            FXMLLoader loader = new FXMLLoader(getClass().getResource("/Login.fxml"));
            Parent root = loader.load();
            Stage stage = (Stage) lblNombreCompleto.getScene().getWindow();
            stage.setScene(new Scene(root));
            stage.show();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    @FXML
    private void cerrarSesion() {
        Alert confirmacion = new Alert(Alert.AlertType.CONFIRMATION);
        confirmacion.setTitle("Cerrar Sesi√≥n");
        confirmacion.setHeaderText("¬øEst√°s seguro?");
        confirmacion.setContentText("¬øDeseas cerrar sesi√≥n?");

        confirmacion.showAndWait().ifPresent(response -> {
            if (response == ButtonType.OK) {
                irALogin();
            }
        });
    }

    private void mostrarAlerta(String mensaje, Alert.AlertType tipo) {
        Alert alert = new Alert(tipo);
        alert.setTitle(tipo == Alert.AlertType.ERROR ? "Error" : 
                      tipo == Alert.AlertType.WARNING ? "Advertencia" : "Informaci√≥n");
        alert.setHeaderText(null);
        alert.setContentText(mensaje);
        alert.showAndWait();
    }
}